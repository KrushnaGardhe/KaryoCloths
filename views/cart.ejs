<% layout('layout') %>
<style>
    /* Custom Styles for Quick-Commerce Cart */
    :root {
        --karyo-primary: #007bff;
        --karyo-success: #28a745; 
        --karyo-danger: #dc3545;
        --karyo-text-muted: #6c757d;
    }

    /* Cart Item Styling */
    .cart-item {
        transition: box-shadow 0.2s;
    }
    .cart-item:hover {
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.05) !important;
    }
    .item-image {
        height: 80px; 
        width: 80px;
        object-fit: cover;
    }
    
    /* Quantity Control: Compact and Grouped */
    .qty-controls {
        width: 90px;
        border: 1px solid #ccc;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .qty-controls button {
        background: none;
        border: none;
        font-weight: bold;
        padding: 0 8px;
        color: var(--karyo-primary);
        cursor: pointer;
    }
    .qty-controls button:disabled {
        color: #ccc;
        cursor: not-allowed;
    }
    .qty-controls span {
        font-size: 0.9rem;
    }

    /* Compact Remove Button next to Price/Subtotal */
    .price-remove-group {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
    }
    .remove-btn-compact {
        color: var(--karyo-danger);
        padding: 4px 6px;
        font-size: 0.8rem;
        border: 1px solid var(--karyo-danger);
        background: none;
        border-radius: 0.25rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    .remove-btn-compact:hover {
        background-color: var(--karyo-danger);
        color: white;
    }


    /* Mobile Layout Adjustments */
    @media (max-width: 767.98px) {
        .cart-item .row > div {
            margin-bottom: 0.5rem;
        }
        .cart-item .col-md-4:nth-child(2) { /* Details column */
            flex-grow: 1;
        }

        /* Group price and removal button horizontally */
        .price-remove-group {
            justify-content: space-between;
            width: 100%;
        }

        /* Hide the default subtotal/remove column on mobile */
        .cart-item .col-md-2:nth-child(5) {
            display: none;
        }

        /* Sticky Footer Action Bar */
        .summary-card-desktop {
            display: none !important;
        }
        .sticky-checkout-bar {
            position: fixed;
            bottom: 60px; /* Above the main mobile navbar (height ~60px) */
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1040;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .checkout-total {
            font-size: 1.5rem;
        }
        
        /* Push content up to clear fixed bar */
        .container.py-5 {
            padding-bottom: 120px !important; /* Increased padding to clear the fixed bar + bottom nav */
        }
    }
    
    @media (min-width: 768px) {
        .sticky-checkout-bar {
            display: none !important;
        }
    }

    /* Non-disruptive Toast Message Styling */
    #cart-message {
       display: none; /* Removed, as simple forms don't support this easily */
    }
</style>

<div id="cart-message" class="alert p-2" role="alert"></div>

<div class="container py-5">
    <div class="row">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Shopping Cart</h2>
                <span class="text-muted" id="item-count"><%= cart.length %> items</span>
            </div>

            <% if (cart.length === 0) { %>
                <div class="text-center py-5 empty-cart-message">
                    <i class="bi bi-bag display-4 text-muted mb-3"></i>
                    <h3>Your cart is empty</h3>
                    <p class="text-muted mb-4">Add some items to get started</p>
                    <a href="/shop" class="btn btn-primary btn-lg">
                        <i class="bi bi-shop"></i> Continue Shopping
                    </a>
                </div>
            <% } else { %>
                <div id="cart-items-container">
                    <% cart.forEach((item, index) => { %>
                        <div class="card mb-3 border-0 shadow-sm cart-item" id="item-row-<%= index %>">
                            <div class="card-body">
                                <div class="row align-items-center g-2 g-md-4">
                                    <div class="col-4 col-md-2">
                                        <img src="<%= item.image %>" class="img-fluid rounded item-image" alt="<%= item.name %>">
                                    </div>
                                    
                                    <div class="col-8 col-md-4">
                                        <h6 class="fw-bold mb-1"><%= item.name %></h6>
                                        <small class="text-muted d-block">
                                            <% if (item.size) { %>Size: <%= item.size %><% } %>
                                            <% if (item.color) { %> | Color: <%= item.color %><% } %>
                                        </small>
                                    </div>
                                    
                                    <div class="col-6 col-md-3">
                                        <small class="text-muted d-block d-md-none mb-1">Quantity:</small>
                                        <div class="qty-controls" data-item-index="<%= index %>">
                                            <button type="button" class="minus-btn" 
                                                onclick="submitQuantityForm(<%= index %>, <%= item.quantity - 1 %>)" 
                                                <%= item.quantity <= 1 ? 'disabled' : '' %>>-</button>
                                            <span class="current-qty"><%= item.quantity %></span>
                                            <button type="button" class="plus-btn" 
                                                onclick="submitQuantityForm(<%= index %>, <%= item.quantity + 1 %>)" 
                                                <%= item.quantity >= 5 ? 'disabled' : '' %>>+</button>
                                        </div>
                                    </div>

                                    <div class="col-6 col-md-3 text-end">
                                        <small class="text-muted d-block d-md-none mb-1">Subtotal:</small>
                                        <div class="price-remove-group">
                                            <h6 class="fw-bold mb-0 subtotal-price" id="subtotal-<%= index %>">
                                                ₹<%= item.price * item.quantity %>
                                            </h6>
                                            
                                            <form action="/cart/remove/<%= index %>" method="POST" class="d-inline">
                                                <button type="submit" class="remove-btn-compact">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>

                <div class="mt-4 d-none d-md-block">
                    <a href="/shop" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Continue Shopping
                    </a>
                </div>
            <% } %>
        </div>

        <% if (cart.length > 0) { %>
            <div class="col-md-4 summary-card-desktop">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <% 
                            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                            const deliveryCost = total < 999 ? 99 : 0;
                            const grandTotal = total + deliveryCost;
                            const savings = Math.floor(total * 0.3);
                        %>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Subtotal (<%= cart.length %> items)</span>
                            <span class="fw-bold">₹<%= total %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Delivery</span>
                            <span class="<%= deliveryCost === 0 ? 'text-success' : 'text-dark' %>"><%= deliveryCost === 0 ? 'FREE' : '₹' + deliveryCost %></span>
                        </div>
                        <% if (total < 999) { %>
                            <div class="alert alert-warning border-0 p-2 mb-3">
                                <small>
                                    <i class="bi bi-info-circle"></i>
                                    Add ₹<%= 999 - total %> more for FREE delivery!
                                </small>
                            </div>
                        <% } %>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <h5>Total</h5>
                            <h5 class="text-success fw-bold checkout-total">₹<%= grandTotal %></h5>
                        </div>
                        <div class="d-flex justify-content-between text-center small mb-4">
                            <div><i class="bi bi-shield-check text-success"></i><div>Secure</div></div>
                            <div><i class="bi bi-truck text-primary"></i><div>Fast Delivery</div></div>
                            <div><i class="bi bi-arrow-repeat text-info"></i><div>Easy Return</div></div>
                        </div>
                        <div class="d-grid">
                            <a href="/cart/checkout" class="btn btn-primary btn-lg">
                                <i class="bi bi-lightning-fill"></i> Proceed to Checkout
                            </a>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted"><i class="bi bi-clock"></i> Delivery in 2-4 hours</small>
                        </div>
                        <div class="card border-0 bg-success text-white mt-3">
                            <div class="card-body p-3">
                                <h6 class="mb-1"><i class="bi bi-piggy-bank"></i> Total Savings!</h6>
                                <p class="mb-0 small fw-bold">You save ₹<%= savings %> on this order!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</div>

<% if (cart.length > 0) { %>
    <% 
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryCost = total < 999 ? 99 : 0;
        const grandTotal = total + deliveryCost;
    %>
    <div class="sticky-checkout-bar" id="mobile-checkout-bar">
        <div class="d-flex justify-content-between align-items-center w-100">
             <div class="d-flex flex-column text-start">
                 <span class="text-muted small">Total:</span>
                 <span class="text-success fw-bold checkout-total">₹<%= grandTotal %></span> 
             </div>
             <a href="/cart/checkout" class="btn btn-primary btn-lg w-50">
                 <i class="bi bi-lightning-fill"></i> Checkout
             </a>
        </div>
    </div>
<% } %>

<script>
// --- UTILITY FOR QUANTITY UPDATE (Submitting Form via JS for fast feel) ---

// This function creates a temporary form and submits it, causing a page reload.
function submitQuantityForm(index, newQuantity) {
    const MAX_QTY = 5;
    const MIN_QTY = 1;
    newQuantity = parseInt(newQuantity);
    
    // 1. Basic validation (prevent submission if quantity is outside bounds)
    if (newQuantity < MIN_QTY || newQuantity > MAX_QTY) {
        return;
    }
    
    // 2. Create a dynamic form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/cart/update'; // This route must handle the update and redirect back.
    
    // 3. Add hidden fields for submission
    
    // Item Index
    const indexInput = document.createElement('input');
    indexInput.type = 'hidden';
    indexInput.name = 'index';
    indexInput.value = index;
    form.appendChild(indexInput);
    
    // New Quantity
    const qtyInput = document.createElement('input');
    qtyInput.type = 'hidden';
    qtyInput.name = 'quantity';
    qtyInput.value = newQuantity;
    form.appendChild(qtyInput);

    // 4. Submit the form
    document.body.appendChild(form);
    form.submit(); // This triggers the POST request and subsequent page reload.
}
</script>

